#!/bin/bash

# Paths
ROOT="${HOME}/.dotfiles"
WEECHAT="${ROOT}/weechat"

# Clone the repository
git clone --recursive git@github.com:disusered/dotfiles.git $HOME/.dotfiles

# Install Homebrew
ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
source $HOME/.bash_profile
brew update
brew upgrade --all
brew install caskroom/cask/brew-cask
brew tap caskroom/versions
brew update

# Install essential packages
brew cask install java xquartz
brew install git git-flow ag wget zsh tmux reattach-to-user-namespace \
node --without-npm python planck ruby rbenv ruby-build python3 \
lua --universal --with-completion luajit --with-52compat \
vim --override-system-vi --with-lua --with-luajit --with-tcl

# Install Neovim
brew tap neovim/neovim
brew reinstall --HEAD neovim
pip2 install --upgrade setuptools
pip2 install --upgrade pip
pip2 install --upgrade --force-reinstall neovim
pip3 install --upgrade setuptools
pip3 install --upgrade pip
pip3 install --upgrade --force-reinstall neovim

# Install FZF
brew install --HEAD fzf

# Symlink zsh configs and install
rm $HOME/.zshrc $HOME/.zshenv
ln -s $ROOT/zsh/zshrc $HOME/.zshrc
ln -s $ROOT/zsh/zshenv $HOME/.zshenv
sudo chpass -s $(which zsh) $USER

# Symlink Tmux config
rm $HOME/.tmux.conf
ln -s $ROOT/tmux/tmux.conf $HOME/.tmux.conf

# Symlink Git config
rm $HOME/.gitconfig $HOME/.gitignore_global
ln -s $ROOT/git/gitconfig $HOME/.gitconfig
ln -s $ROOT/git/gitignore_global $HOME/.gitignore_global

# Symlink Slate confi
rm $HOME/.slate $HOME/.slate.js
ln -s $ROOT/slate/slate.js $HOME/.slate.js

# Symlink Neo/Vim config and install plugins
mkdir -p $ROOT/vim/autoload
rm $ROOT/vim/autoload/plug.vim
ln -s $ROOT/vendor/vim-plug/plug.vim $ROOT/vim/autoload/plug.vim
rm -rf $HOME/.vim $HOME/.vimrc $HOME/.gvimrc $HOME/.config/nvim
ln -s $ROOT/vim $HOME/.vim
ln -s $ROOT/vim/vimrc $HOME/.vimrc
ln -s $ROOT/vim/gvimrc $HOME/.gvimrc
ln -s $ROOT/vim $HOME/.config/nvim

# iTerm ^H fix
FIX='s/kbs=^[hH]/kbs=\\177/';
infocmp $TERM | sed $FIX > $ROOT/vendor/$TERM.ti
infocmp screen-256color | sed $FIX > $ROOT/vendor/screen-256color.ti
tic $ROOT/vendor/$TERM.ti
tic $ROOT/vendor/screen-256color.ti

# Symlink Ag config
rm $HOME/.agignore
ln -s $ROOT/ag/agignore $HOME/.agignore

# Hide last-logged-in message on new terminals
touch $HOME/.hushlogin

# Install fonts
rm -rf $HOME/.fonts
mkdir -p $HOME/Library/Fonts $HOME/.fonts
unzip -o $ROOT/vendor/meslo/dist/v1.2.1/Meslo\ LG\ DZ\ v1.2.1.zip \
  -d /tmp
find /tmp/Meslo\ LG\ DZ\ v1.2.1 -type f -name "*.ttf" \
  -exec cp "{}" $HOME/.fonts/ \;
find $ROOT/vendor/powerline-fonts -type f -name "*.*tf" \
  -exec cp "{}" $HOME/.fonts/ \;
find $ROOT/vendor/powerline-fonts -type f -name "*.pcf.gz" \
  -exec cp "{}" $HOME/.fonts/ \;
find $HOME/.fonts -type f -name "*.*tf" \
  -exec cp "{}" $HOME/Library/Fonts/ \;
find $ROOT/vendor/nerd-fonts/patched-fonts/SourceCodePro/ \
  -type f -name "*.*tf" -exec cp "{}" $HOME/Library/Fonts/ \;
fc-cache -vf ~/.fonts

# Install nvm
git clone https://github.com/creationix/nvm.git ~/.nvm && cd ~/.nvm && git checkout `git describe --abbrev=0 --tags`
source $HOME/.nvm/nvm.sh
nvm install node
nvm alias default node

# Install npm and packages
echo prefix=~/.npm-packages > ~/.npmrc
curl -L https://npmjs.com/install.sh | sh
npm install -g npm@latest
npm update -g npm
# vim deps
npm install -g eslint babel babel-cli babel-eslint jsonlint jshint \
eslint-config-metalab eslint-config-airbnb eslint-config-google \
eslint-plugin-filenames eslint-plugin-import eslint-plugin-jsx-a11y \
eslint-plugin-react flow-bin \
caniuse-cmd neovim-client csscomb
# node deps
npm install -g yo gulp grunt-cli cordova ionic http-server forever \
ios-deploy ios-sim karma-cli bower nesh node-inspector nodemon \
phonegap plugman svgo browserify david mocha redux-cli \
term-img-cli  typescript
nesh --enable nesh-lodash
nesh --enable nesh-history-search

# Elixir
mix local.hex
mix archive.install https://github.com/phoenixframework/archives/raw/master/phoenix_new.ez

# Python Packages
pip install requests websocket-client pync pafy rainbowstream

# PHP
curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer

# Extras and related dependencies
brew install watch dict tree ncdu nmap htop mediainfo atool \
highlight ranger watchman jq ansible ant httpie gradle gcc \
imagemagick --with-webp graphicsmagick --with-webp \
ffmpeg --with-faac --with-fdk-aac --with-openssl --with-tools --with-webp \
android-sdk aspell --with-lang-es --with-lang-en \
weechat --with-aspell --with-curl --with-lua --with-perl --with-python --with-ruby \
inkscape --with-poppler pandoc w3m heroku-toolbelt

# Configure htop
HTOP_VERSION=$(brew info htop | awk 'NR==1{ print $3 }')
sudo chown root:wheel /usr/local/Cellar/htop-osx/$HTOP_VERSION/bin/htop
sudo chmod u+s /usr/local/Cellar/htop-osx/$HTOP_VERSION/bin/htop

# Rainbow
ln -s $ROOT/rainbow/rainbow_config.json .rainbow_config.json

# Weechat
rm -rf $HOME/.weechat
ln -s $WEECHAT $HOME/.weechat

# Enable X extension for Slate/xdotool
defaults write org.x.X11 enable_test_extensions -boolean true

# Install ranger
ROOT="${HOME}/.dotfiles"
rm $HOME/.config/ranger
ln -s $ROOT/ranger $HOME/.config/ranger

# Install Aqua apps
brew cask install alfred java kaleidoscope karabiner seil sourcetree slate \
transmission flux appcleaner keepingyouawake imageoptim imagealpha charles \
paw iterm2-nightly licecap webkit-nightly virtualbox vagrant unicodechecker \
firefox firefoxdeveloperedition teleport vlc virtualbox-extension-pack \
dockertoolbox macid bartender

# Configure QuickLook
brew cask install qlcolorcode qlstephen qlmarkdown quicklook-json \
qlprettypatch quicklook-csv betterzipql qlimagesize webpquicklook \
suspicious-package

defaults write com.apple.finder QLEnableTextSelection -bool true && killall Finder

# Install ranger
ROOT="${HOME}/.dotfiles"
rm $HOME/.config/ranger
ln -s $ROOT/ranger $HOME/.config/ranger

# Setup imgcat
chmod +x $ROOT/bin/imgcat
